name: Deploy to Kubernetes

on:
  workflow_run:
    workflows: ["Build and Push Agents"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  REGISTRY: ${{ secrets.DOCKER_REGISTRY }}
  IMAGE_TAG: ${{ github.sha }}

jobs:
  deploy-staging:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging'
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - uses: actions/checkout@v4
      
      - name: Configure kubectl
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG_STAGING }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
      
      - name: Update deployment image
        run: |
          kubectl -n kubric set image deployment/api \
            api=${{ env.REGISTRY }}/kubric-api:${{ env.IMAGE_TAG }}
          kubectl -n kubric set image deployment/kai-orchestration \
            kai=${{ env.REGISTRY }}/kubric-kai:${{ env.IMAGE_TAG }}
          kubectl -n kubric set image deployment/web-portal \
            web=${{ env.REGISTRY }}/kubric-web:${{ env.IMAGE_TAG }}
      
      - name: Wait for rollout
        run: |
          kubectl -n kubric rollout status deployment/api --timeout=5m
          kubectl -n kubric rollout status deployment/kai-orchestration --timeout=5m
          kubectl -n kubric rollout status deployment/web-portal --timeout=5m
      
      - name: Run smoke tests
        run: |
          kubectl -n kubric run smoke-test \
            --image=${{ env.REGISTRY }}/kubric-smoke-tests:latest \
            --restart=Never \
            -- /app/smoke-tests.sh

  deploy-production:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production'
    runs-on: ubuntu-latest
    environment: production
    concurrency:
      group: production-deploy
      cancel-in-progress: false
    steps:
      - uses: actions/checkout@v4
      
      - name: Require approval
        run: |
          echo "Production deployment requires manual approval via environment protection rules"
      
      - name: Configure kubectl
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.KUBE_CONFIG_PROD }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config
      
      - name: Create rollout policy (blue-green)
        run: |
          # Deployment strategy: blue-green with 5-minute observation period
          kubectl -n kubric patch deployment api --patch-file - <<EOF
          {
            "spec": {
              "strategy": {
                "type": "RollingUpdate",
                "rollingUpdate": {
                  "maxSurge": "50%",
                  "maxUnavailable": "0%"
                }
              }
            }
          }
          EOF
      
      - name: Update deployment
        run: |
          kubectl -n kubric set image deployment/api \
            api=${{ env.REGISTRY }}/kubric-api:${{ env.IMAGE_TAG }}
          kubectl -n kubric set image deployment/kai-orchestration \
            kai=${{ env.REGISTRY }}/kubric-kai:${{ env.IMAGE_TAG }}
      
      - name: Wait for rollout (5min timeout)
        run: |
          kubectl -n kubric rollout status deployment/api --timeout=5m
          kubectl -n kubric rollout status deployment/kai-orchestration --timeout=5m
      
      - name: Health check
        run: |
          for i in {1..10}; do
            if curl -f https://api.kubric.io/health; then
              echo "✅ Health check passed"
              exit 0
            fi
            echo "Attempt $i/10..."
            sleep 10
          done
          echo "❌ Health check failed"
          kubectl -n kubric rollout undo deployment/api
          exit 1
      
      - name: Notify Slack
        if: success()
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "✅ Production deployment successful for commit ${{ github.sha }}"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
      
      - name: Rollback on failure
        if: failure()
        run: |
          kubectl -n kubric rollout undo deployment/api
          kubectl -n kubric rollout undo deployment/kai-orchestration
