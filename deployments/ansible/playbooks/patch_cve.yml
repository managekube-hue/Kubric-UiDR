---
- name: Patch CVE vulnerabilities
  hosts: all
  gather_facts: yes
  vars:
    maintenance_window: "{{ maintenance_window | default('02:00-04:00') }}"
  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"

    - name: Install security updates
      apt:
        name: "*"
        state: latest
        only_upgrade: yes
      when: ansible_os_family == "Debian"

    - name: Check for required reboot
      stat:
        path: /var/run/reboot-required
      register: reboot_required

    - name: Notify scheduled reboot
      debug:
        msg: "Host {{ inventory_hostname }} requires reboot"
      when: reboot_required.stat.exists

    - name: Schedule safe reboot
      shell: shutdown -r +30 "CVE patches applied. Rebooting in 30 minutes."
      when: reboot_required.stat.exists and force_immediate_reboot is not defined

    - name: Log patch event
      shell: |
        echo "CVE patches applied to {{ inventory_hostname }} at $(date)" >> /var/log/kubric-patching.log
